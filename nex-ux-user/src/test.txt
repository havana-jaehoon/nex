# 0.네트웍 생성 (초기에 한번만 수행 하면 됨)
#oc -n cibc create configmap cm-config --from-file=CM/config --dry-run=client -o yaml | oc apply -f -
oc apply -f yaml/nad/nad-cibc-static.yaml

# 0.1 네트웍 지우기
oc -n cibc delete net-attach-def net-mon
oc -n cibc delete net-attach-def net-ipc
oc -n cibc delete net-attach-def net-ext


# 1. 프로젝트 생성 (초기에 한번만 수행 하면 됨)
oc new-project cibc || oc project cibc


# 2. (선택) IS 미리 생성 (초기에 한번만 수행 하면 됨)
oc -n cibc create imagestream cm || true
oc -n cibc create imagestream cm-ccm || true
oc -n cibc create imagestream cm-oam || true


# 3. 바이너리 빌드(도커 전략)
oc -n cibc new-build --binary --name=cm --strategy=docker || true
oc -n cibc new-build --binary --name=cm-ccm --strategy=docker || true
oc -n cibc new-build --binary --name=cm-oam --strategy=docker || true


# 4. 빌드 실행 (로컬 ./CM 에 Dockerfile 존재) 
# Dokerfile 이 변경되거나 CM 디렉토리내 변경이 있는 경우 여기부터 수행
# 변경이 기존과 많이 다른경우 빌드된 이미지 삭제(Web에서) 후 재실행
oc -n cibc start-build cm --from-dir=./CM/CCM --follow
oc -n cibc start-build cm --from-dir=./CM/OAM --follow


# (선택) 태그 고정 ==> 생략
oc tag -n cibc cm:latest cm:1.0

# 5.  배포

oc apply -f yaml/deploy/deploy-cibc-cm1a.yaml
oc apply -f yaml/deploy/deploy-cibc-cm1b.yaml

===== 필요시(참조용 대부분 웹에서 볼 수 있음) ====
# 상태 체크
oc -n cibc rollout status deploy/cm1a
oc -n cibc rollout status deploy/cm1b

#재시작 
oc -n cibc rollout restart deploy/cm1a

# 상태보기
oc -n cibc logs deploy/cm1a -c cm --tail=200

oc -n cibc rollout status deploy/cm
oc -n cibc describe pod cm | sed -n '1,220p'


# 실행중인데 정상이 아닌 pod 지우기
oc -n cibc delete pod -l app=cm --field-selector=status.phase!=Running


# 배포된 pod 지우기
oc -n cibc delete deploy cm1a


#로그확인
# 네트웍 생성 상태 확인
oc -n cibc get net-attach-def net-mon -o yaml | sed -n '1,120p'

# Pod 상태 확인
oc -n cibc get pods -l app=cm -o wide
oc -n cibc describe pod cm | sed -n '1,220p'
